from scripts.exploit.attack_chains.apache import evaluate_apache
# from scripts.exploit.engine.attack_chains.ssh import evaluate_ssh  # plus tard


class AttackChainEngine:
    """
    Orchestrateur des chaînes d’attaque.
    Il appelle chaque moteur de service (Apache, SSH, PHP, etc.)
    et retourne la meilleure chaîne d’attaque possible.
    """

    def __init__(self):
        self.engines = [
            evaluate_apache,
            # evaluate_ssh,
        ]

    def evaluate(self, facts):
        """
        facts = {
            "target": "127.0.0.1",
            "service": "Apache",
            "version": "2.4.52",
            "cve": "CVE-2022-22720",
            "validated": True,
            "headers": {...}
        }
        """

        if not facts.get("validated"):
            return {
                "status": False,
                "impact": "not_validated",
                "proof": "CVE not technically validated"
            }

        for engine in self.engines:
            try:
                result = engine(facts)
                if result:
                    return {
                        "status": True,
                        "impact": "attack_chain_available",
                        "attack": result["attack"],
                        "confidence": result["confidence"],
                        "service": facts["service"],
                        "version": facts["version"],
                        "cve": facts["cve"],
                        "proof": result.get("proof")
                    }
            except Exception as e:
                continue

        return {
            "status": False,
            "impact": "no_attack_chain",
            "service": facts.get("service"),
            "version": facts.get("version"),
            "cve": facts.get("cve"),
            "proof": "No applicable attack chain found"
        }
