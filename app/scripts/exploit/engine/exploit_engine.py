from scripts.exploit.engine.exploit_mapper import ExploitMapper


class ExploitEngine:
    """
    Prend les faits (service, version, CVE validées)
    et détermine s’il existe une chaîne d’attaque exploitable.
    """

    def __init__(self):
        self.mapper = ExploitMapper()

    def analyze(self, target, service, version, cve):
        rec = self.mapper.map(cve, service, version)

        if not rec:
            return {
                "status": False,
                "impact": "no_exploit",
                "proof": "No attack chain mapped",
                "target": target,
                "service": service,
                "version": version,
                "cve": cve
            }

        return {
            "status": True,
            "impact": "attack_chain_available",
            "attack_family": rec["attack_family"],
            "risk": rec["risk"],
            "confidence": rec["confidence"],
            "target": target,
            "service": service,
            "version": version,
            "cve": cve,
            "proof": f"Matched {rec['attack_family']} with {rec['confidence']*100:.0f}% confidence"
        }
