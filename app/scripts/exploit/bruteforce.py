# scripts/exploit/bruteforce.py
from scripts.exploit.security_engine import SecurityEngine
from scripts.exploit.exploit_engine import ExploitEngine
import sys, os, json, re
import urllib.request, urllib.parse, warnings
from concurrent.futures import ThreadPoolExecutor
from scripts.db.mysql_conn import get_connection

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))

def parse_cves(raw):
    out = []
    for part in raw.split(","):
        m = re.match(r'(CVE-\d{4}-\d+)\(([\d.]+)\|([A-Z]+)\)', part.strip())
        if m:
            out.append({"cve": m.group(1), "score": float(m.group(2)), "sev": m.group(3)})
    return out

def main():
    user_id, target = sys.argv[1], sys.argv[2]

    conn = get_connection()
    cur = conn.cursor(dictionary=True)

    cur.execute("""
        SELECT script_vuln FROM scanner
        JOIN ping ON scanner.ping_id = ping.id
        WHERE ping.user_id=%s AND ping.ip_address=%s LIMIT 1
    """, (user_id, target))
    row = cur.fetchone()

    print(f"\n==== Exploit de la cible {target} ======\n")
    print(row)

    cves = parse_cves(row["script_vuln"])

    high = [c for c in cves if c["sev"] == "HIGH"]

    cur.execute("""
        SELECT service, version FROM scanner
        JOIN ping ON scanner.ping_id = ping.id
        WHERE ping.user_id=%s AND ping.ip_address=%s
    """, (user_id, target))
    services = cur.fetchall()

    sec = SecurityEngine()
    exp = ExploitEngine()

    results = []

    for cve in high:
        modules = sec.search_modules(cve["cve"])
        for m in modules:
            val = sec.run_module(m, target)
            for svc in services:
                impact = exp.run(target, svc["service"], svc["version"], cve["cve"])
                results.append({
                    "cve": cve["cve"],
                    "module": m,
                    "payload": "poc",
                    "status": val["status"] == "exploitable" and impact["status"],
                    "proof": f"{val['proof']} | {impact['proof']}",
                    "output": json.dumps({"validation": val, "impact": impact})
                })

    print("\n---JSON-RESULT---")
    print(json.dumps(results))

if __name__ == "__main__":
    main()
