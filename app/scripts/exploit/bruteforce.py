import sys, json, re
from scripts.db.mysql_conn import get_connection
from scripts.exploit.security_engine import SecurityEngine
from scripts.exploit.exploit_engine import ExploitEngine

def parse_cves(raw):
    out = []
    for p in raw.split(","):
        m = re.match(r'(CVE-\d{4}-\d+)\(([\d.]+)\|([A-Z]+)\)', p.strip())
        if m:
            out.append({"cve": m.group(1), "score": float(m.group(2)), "sev": m.group(3)})
    return out

def main():
    user_id, target = sys.argv[1], sys.argv[2]

    conn = get_connection()
    cur = conn.cursor(dictionary=True)

    cur.execute("""
        SELECT scanner.script_vuln, scanner.service, scanner.version
        FROM scanner
        JOIN ping ON scanner.ping_id = ping.id
        WHERE ping.user_id=%s AND ping.ip_address=%s
    """, (user_id, target))

    rows = cur.fetchall()

    print(f"\n==== Exploit de la cible {target} ======\n")

    sec = SecurityEngine()
    exp = ExploitEngine()
    results = []

    for r in rows:
        cves = parse_cves(r["script_vuln"] or "")
        for c in cves:
            if c["sev"] not in ("HIGH", "CRITICAL"):
                continue

            modules = sec.search_modules(c["cve"])
            for m in modules:
                val = sec.run_module(m, target)

                if val["status"] != "exploitable":
                    continue

                impact = exp.analyze(target, r["service"], r["version"], c["cve"])

                results.append({
                    "cve": c["cve"],
                    "service": r["service"],
                    "version": r["version"],
                    "validation": val,
                    "impact": impact
                })

    print("\n---JSON-RESULT---")
    print(json.dumps(results, indent=2))

if __name__ == "__main__":
    main()
