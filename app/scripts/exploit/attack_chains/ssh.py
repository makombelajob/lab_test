def evaluate_ssh(facts):
    """
    facts = {
        "service": "OpenSSH",
        "version": "8.2p1",
        "validated_cves": [...],
        "headers": [...],
    }
    """

    service = (facts.get("service") or "").lower()
    version = facts.get("version") or ""
    cves = set(facts.get("validated_cves", []))
    headers = " ".join(facts.get("headers", [])).lower()

    if "ssh" not in service and "openssh" not in service:
        return None

    # Extraire la version OpenSSH (format: X.YpN ou X.Y.Z)
    openssh_version = None
    if version:
        openssh_version = version

    # ===============================
    # 1️⃣ OpenSSH Username Enumeration (CVE-2018-15473)
    # ===============================
    if "CVE-2018-15473" in cves:
        return {
            "attack": "OpenSSH username enumeration",
            "confidence": 0.85,
            "exploit": "exploit/ssh/ssh_enumusers"
        }

    # ===============================
    # 2️⃣ OpenSSH RCE (CVE-2020-15778)
    # ===============================
    if "CVE-2020-15778" in cves:
        return {
            "attack": "OpenSSH command injection → RCE",
            "confidence": 0.90,
            "exploit": "exploit/ssh/openssh_command_injection"
        }

    # ===============================
    # 3️⃣ OpenSSH X11 Forwarding RCE (CVE-2019-6111)
    # ===============================
    if "CVE-2019-6111" in cves or "CVE-2019-6109" in cves:
        return {
            "attack": "OpenSSH X11 forwarding / file disclosure",
            "confidence": 0.80,
            "exploit": "exploit/ssh/openssh_x11_forward"
        }

    # ===============================
    # 4️⃣ OpenSSH 7.4 and below vulnerabilities
    # ===============================
    if openssh_version:
        try:
            # Extraire le numéro de version principal
            if "p" in openssh_version:
                major_minor = openssh_version.split("p")[0]
            else:
                parts = openssh_version.split(".")
                major_minor = f"{parts[0]}.{parts[1]}" if len(parts) >= 2 else openssh_version

            version_float = float(major_minor)
            
            if version_float <= 7.4 and any(cve.startswith("CVE-2017") for cve in cves):
                return {
                    "attack": "OpenSSH 7.4 and below vulnerabilities (RCE candidates)",
                    "confidence": 0.75,
                    "exploit": None
                }
        except (ValueError, AttributeError):
            pass

    # ===============================
    # 5️⃣ OpenSSH Legacy Versions (pre-7.0)
    # ===============================
    if openssh_version:
        try:
            if "p" in openssh_version:
                major_minor = openssh_version.split("p")[0]
            else:
                parts = openssh_version.split(".")
                major_minor = f"{parts[0]}.{parts[1]}" if len(parts) >= 2 else openssh_version

            version_float = float(major_minor)
            
            if version_float < 7.0:
                return {
                    "attack": "OpenSSH legacy version (known vulnerabilities)",
                    "confidence": 0.85,
                    "exploit": None
                }
        except (ValueError, AttributeError):
            pass

    # ===============================
    # 6️⃣ OpenSSH Brute Force / Weak Keys
    # ===============================
    if any(cve.startswith("CVE-") for cve in cves):
        return {
            "attack": "OpenSSH brute force / weak key exploitation",
            "confidence": 0.60,
            "exploit": None
        }

    # ===============================
    # 7️⃣ Generic SSH vulnerabilities
    # ===============================
    if any(cve.startswith("CVE-202") for cve in cves):
        return {
            "attack": "OpenSSH recent vulnerabilities (RCE candidates)",
            "confidence": 0.70,
            "exploit": None
        }

    return None