def evaluate_smb(facts):
    """
    facts = {
        "service": "SMB",
        "version": "3.1.1",
        "validated_cves": [...],
        "headers": [...],
    }
    """

    service = (facts.get("service") or "").lower()
    version = facts.get("version") or ""
    cves = set(facts.get("validated_cves", []))
    headers = " ".join(facts.get("headers", [])).lower()

    # Vérifier si c'est un service SMB
    if "smb" not in service:
        return None

    # ===============================
    # 1️⃣ EternalBlue (MS17-010) - CVE-2017-0143 à CVE-2017-0148
    # ===============================
    eternalblue_cves = {
        "CVE-2017-0143",
        "CVE-2017-0144",
        "CVE-2017-0145",
        "CVE-2017-0146",
        "CVE-2017-0147",
        "CVE-2017-0148"
    }
    if any(cve in cves for cve in eternalblue_cves):
        return {
            "attack": "SMB EternalBlue (MS17-010) RCE",
            "confidence": 0.95,
            "exploit": "exploit/smb/eternalblue_ms17_010"
        }

    # ===============================
    # 2️⃣ SMBGhost (CVE-2020-0796) - SMBv3 Compression
    # ===============================
    if "CVE-2020-0796" in cves:
        return {
            "attack": "SMBGhost (SMBv3 compression) RCE",
            "confidence": 0.90,
            "exploit": "exploit/smb/smbghost_cve_2020_0796"
        }

    # ===============================
    # 3️⃣ Samba Remote Code Execution (CVE-2021-44142)
    # ===============================
    if "CVE-2021-44142" in cves:
        return {
            "attack": "Samba VFS module RCE (CVE-2021-44142)",
            "confidence": 0.85,
            "exploit": "exploit/smb/samba_vfs_rce"
        }

    # ===============================
    # 4️⃣ SMB Relay Attacks
    # ===============================
    if any(cve.startswith("CVE-2019") or cve.startswith("CVE-2020") for cve in cves):
        return {
            "attack": "SMB relay / NTLM relay attack",
            "confidence": 0.75,
            "exploit": None
        }

    # ===============================
    # 5️⃣ SMB Null Session / Anonymous Access
    # ===============================
    if any(cve.startswith("CVE-") for cve in cves):
        return {
            "attack": "SMB null session / anonymous access exploitation",
            "confidence": 0.60,
            "exploit": None
        }

    return None